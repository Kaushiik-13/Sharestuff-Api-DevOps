name: NestJS CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:


jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout source code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # 3Ô∏è‚É£ Install dependencies
    - name: Install dependencies
      run: npm install

    # 4Ô∏è‚É£ Build NestJS app
    - name: Build application
      run: npm run build

    # 5Ô∏è‚É£ Build Docker image
    - name: Build Docker image
      run: docker build -t sharestuff-api-ci .

    # 6Ô∏è‚É£ Run container (CI mode ‚Äì NO DB)
    - name: Run container (CI mode)
      run: |
        docker run -d --name sharestuff-ci \
          -p 3000:3000 \
          -e NODE_ENV=ci \
          -e PORT=3000 \
          -e ENABLE_DB=false \
          -e ENABLE_MAILER=false \
          -e ENABLE_AUTH=false \
          sharestuff-api-ci

    # 7Ô∏è‚É£ Wait for app startup
    - name: Wait for app to start
      run: sleep 15

    # 8Ô∏è‚É£ Show logs (debug safety)
    - name: Show container logs
      run: docker logs sharestuff-ci || true

    # 9Ô∏è‚É£ Health check
    - name: Health check
      run: curl -f http://localhost:3000/health

    # üîü Cleanup CI container
    - name: Cleanup CI container
      run: |
        docker stop sharestuff-ci || true
        docker rm sharestuff-ci || true

    # üîê Login to Docker Hub
    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    # üè∑Ô∏è Tag Docker image
    - name: Tag Docker image
      run: docker tag sharestuff-api-ci ${{ secrets.DOCKERHUB_USERNAME }}/sharestuff-api:latest

    # üöÄ Push Docker image
    - name: Push Docker image
      run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/sharestuff-api:latest

    # üöÄüöÄ CD ‚Äî Deploy to EC2 (ONLY on main)
    - name: Deploy to EC2 (CD)
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/sharestuff-api:latest

          docker stop sharestuff-api || true
          docker rm sharestuff-api || true

          docker run -d \
            --name sharestuff-api \
            -p 3000:3000 \
            --restart unless-stopped \
            --env-file /home/ubuntu/.env.production \
            ${{ secrets.DOCKERHUB_USERNAME }}/sharestuff-api:latest
