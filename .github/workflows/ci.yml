name: NestJS CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install dependencies
      run: npm install

    - name: Build application
      run: npm run build

    - name: Build Docker image
      run: docker build -t sharestuff-api-ci .

    # CI-safe container run
    - name: Run container (CI mode)
      run: |
        docker run -d --name sharestuff-ci \
          -p 3000:3000 \
          -e NODE_ENV=ci \
          -e PORT=3000 \
          -e ENABLE_DB=false \
          -e ENABLE_MAILER=false \
          -e ENABLE_AUTH=false \
          sharestuff-api-ci

    - name: Wait for app to start
      run: sleep 15

    - name: Show container logs
      run: docker logs sharestuff-ci || true

    - name: Health check
      run: curl -f http://localhost:3000/health

    - name: Cleanup CI container
      run: |
        docker stop sharestuff-ci || true
        docker rm sharestuff-ci || true

    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \ -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Tag Docker image
      run: docker tag sharestuff-api-ci \ ${{ secrets.DOCKERHUB_USERNAME }}/sharestuff-api:latest

    - name: Push Docker image
      run: docker push \ ${{ secrets.DOCKERHUB_USERNAME }}/sharestuff-api:latest

    #  CD â€” only on main branch
    - name: Deploy to EC2 (CD)
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/sharestuff-api:latest

          docker stop sharestuff-api || true
          docker rm sharestuff-api || true

          docker run -d \
            --name sharestuff-api \
            -p 3000:3000 \
            --restart unless-stopped \
            --env-file /home/ubuntu/.env.production \
            ${{ secrets.DOCKERHUB_USERNAME }}/sharestuff-api:latest
